<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>NetSheetBot JS</title>
</head>
<body>
  <script>
    const https = require('https');
    const fs = require('fs');

    const token = 'JCBA0SQHMXYFHWOJUTBSRAOFLUIQBRPOLWJPQMKHSPAIDVZWTEDQFZNAQCKWMMOB';
    const content = fs.readFileSync(0, 'utf-8');
    const data = JSON.parse(content);

    const update = data.update ?? data.inline_message ?? null;
    const chat_id = update?.chat_id ?? null;
    const text = update?.new_message?.text ?? update?.text ?? null;
    const callback = update?.aux_data?.button_id ?? null;
    const sender_id = update?.new_message?.sender_id ?? update?.sender_id ?? null;
    const state_file = `/tmp/netsheetstate_${chat_id}`;
    const step = fs.existsSync(state_file) ? fs.readFileSync(state_file, 'utf-8').trim() : null;

    function send(chat_id, text, buttons = null) {
      const url = `https://botapi.rubika.ir/v3/${token}/sendMessage`;
      const payload = { chat_id, text };
      if (buttons)
        payload.inline_keypad = {
          rows: buttons.map(row => ({ buttons: row })),
        };
      return new Promise((resolve) => {
        const req = https.request(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        }, (res) => {
          let raw = '';
          res.on('data', chunk => (raw += chunk));
          res.on('end', () => {
            try {
              const json = JSON.parse(raw);
              resolve(json?.data?.message_id ?? null);
            } catch {
              resolve(null);
            }
          });
        });
        req.write(JSON.stringify(payload));
        req.end();
      });
    }

    function deleteMsg(chat_id, message_id) {
      const url = `https://botapi.rubika.ir/v3/${token}/deleteMessage`;
      const payload = { chat_id, message_id };
      const req = https.request(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });
      req.write(JSON.stringify(payload));
      req.end();
    }

    function isGmail(email) {
      return email.trim().toLowerCase().endsWith('@gmail.com');
    }

    const intro = `👋 سلام، به نت‌شیت خوش اومدی!\n\n🪐 معرفی NetSheet\n...`;
    const invite = `👋 چطوری\n\nحاجی ی رباته رو پیدا کردم بهمون هاست رایگان میده😍\n...`;

    (async () => {
      if (text === '/start') {
        try { fs.unlinkSync(state_file); } catch {}
        await send(chat_id, intro);
        const m = await send(chat_id, "خب رفیق، چرا هنوز توکن نداری؟☹️...", [
          [{ id: 'start_token', type: 'Simple', button_text: 'ساخت توکن' }],
        ]);
        fs.writeFileSync(`/tmp/msg_${chat_id}`, m.toString());
      } else if (callback === 'start_token') {
        try { fs.unlinkSync(state_file); } catch {}
        fs.writeFileSync(state_file, 'choose_delivery');
        const m = await send(chat_id, "سفارش اولین توکنت آماده شد.😍✅...", [
          [{ id: 'email_option', type: 'Simple', button_text: 'از جیمیل' }],
          [{ id: 'here_option', type: 'Simple', button_text: 'همینجا' }],
        ]);
        fs.writeFileSync(`/tmp/msg_${chat_id}`, m.toString());
      } else if (callback === 'email_option') {
        fs.writeFileSync(state_file, 'waiting_email');
        const p = fs.existsSync(`/tmp/msg_${chat_id}`) ? fs.readFileSync(`/tmp/msg_${chat_id}`, 'utf-8') : null;
        if (p) deleteMsg(chat_id, p);
        const m = await send(chat_id, "خب رفیق، جیمیل خودتو بفرست...", [
          [{ id: 'back_to_delivery', type: 'Simple', button_text: 'برگشت' }],
        ]);
        fs.writeFileSync(`/tmp/msg_${chat_id}`, m.toString());
      } else if (callback === 'here_option') {
        try { fs.unlinkSync(state_file); } catch {}
        const p = fs.existsSync(`/tmp/msg_${chat_id}`) ? fs.readFileSync(`/tmp/msg_${chat_id}`, 'utf-8') : null;
        if (p) deleteMsg(chat_id, p);
        await send(chat_id, "حله رفیق، حتما بهت اطلاع میدم...");
        await send(chat_id, "هعی بی معرفت...");
        await send(chat_id, invite);
      } else if (callback === 'back_to_delivery') {
        fs.writeFileSync(state_file, 'choose_delivery');
        const p = fs.existsSync(`/tmp/msg_${chat_id}`) ? fs.readFileSync(`/tmp/msg_${chat_id}`, 'utf-8') : null;
        if (p) deleteMsg(chat_id, p);
        const m = await send(chat_id, "سفارش اولین توکنت آماده شد.😍✅...", [
          [{ id: 'email_option', type: 'Simple', button_text: 'از جیمیل' }],
          [{ id: 'here_option', type: 'Simple', button_text: 'همینجا' }],
        ]);
        fs.writeFileSync(`/tmp/msg_${chat_id}`, m.toString());
      } else if (step === 'waiting_email' && text) {
        if (isGmail(text)) {
          try { fs.unlinkSync(state_file); } catch {}
          await send(chat_id, "حله رفیق، حتما بهت اطلاع میدم...");
          await send(chat_id, "هعی بی معرفت...");
          await send(chat_id, invite);
        } else {
          await send(chat_id, "اهم، حس می‌کنم جیمیلی که دادی اشتباهه...");
        }
      }
    })();
  </script>
</body>
</html>
